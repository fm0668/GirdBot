



### **ç½‘æ ¼å¯¹å†²ç­–ç•¥ï¼šæ‰§è¡Œä¸ç›‘æ§é˜¶æ®µé€»è¾‘**

**â€œåŒå‘æŒ‚å•è¡¥ä»“â€**é€»è¾‘è¯´æ˜:

- **æœ€å¤§åŒæ—¶æŒ‚å•æ•°æ§åˆ¶**: é€šè¿‡ `max_open_orders` å‚æ•°ï¼ˆå¦‚è®¾ç½®ä¸º2ï¼‰æ§åˆ¶åŒæ—¶æ´»è·ƒçš„è®¢å•æ•°é‡
- **è·ç¦»ä¼˜å…ˆåŸåˆ™**: ä¼˜å…ˆæ¿€æ´»è·ç¦»å½“å‰å¸‚ä»·æœ€è¿‘çš„ç½‘æ ¼è®¢å•ï¼Œç¡®ä¿äº¤æ˜“æœºä¼šæœ€å¤§åŒ–
- **åŒå‘è¦†ç›–ä¿è¯**: 
  - **å¤šå¤´è´¦æˆ·**ï¼šç¡®ä¿åœ¨å¸‚ä»·ä¸Šæ–¹å’Œä¸‹æ–¹å‡æœ‰ä¹°å•ï¼ˆä¹°å…¥åšå¤šï¼‰
    - `max_open_orders=2`: å¸‚ä»·ä¸Šæ–¹æŒ‚1ä¸ªä¹°å•ï¼Œä¸‹æ–¹æŒ‚1ä¸ªä¹°å•
    - `max_open_orders=4`: å¸‚ä»·ä¸Šæ–¹æŒ‚2ä¸ªä¹°å•ï¼Œä¸‹æ–¹æŒ‚2ä¸ªä¹°å•
    - **è¡¥ä»“æœºåˆ¶**ï¼šä»·æ ¼å›è°ƒæ—¶å¯ä»¥æˆäº¤ï¼Œå®ç°è¡¥ä»“æ•ˆæœ
  - **ç©ºå¤´è´¦æˆ·**ï¼šç¡®ä¿åœ¨å¸‚ä»·ä¸Šæ–¹å’Œä¸‹æ–¹å‡æœ‰å–å•ï¼ˆå–å‡ºåšç©ºï¼‰
    - `max_open_orders=2`: å¸‚ä»·ä¸Šæ–¹æŒ‚1ä¸ªå–å•ï¼Œä¸‹æ–¹æŒ‚1ä¸ªå–å•
    - `max_open_orders=4`: å¸‚ä»·ä¸Šæ–¹æŒ‚2ä¸ªå–å•ï¼Œä¸‹æ–¹æŒ‚2ä¸ªå–å•
    - **è¡¥ä»“æœºåˆ¶**ï¼šä»·æ ¼ä¸Šæ¶¨æ—¶å¯ä»¥æˆäº¤ï¼Œå®ç°è¡¥ä»“æ•ˆæœ
- **åŒå‘è¡¥ä»“ç­–ç•¥**: 
  - æ— è®ºä»·æ ¼å‘å“ªä¸ªæ–¹å‘ç§»åŠ¨ï¼Œéƒ½èƒ½é€šè¿‡é¢„è®¾çš„é™ä»·å•å®ç°è‡ªåŠ¨è¡¥ä»“
  - æé«˜èµ„é‡‘åˆ©ç”¨æ•ˆç‡ï¼Œå¢å¼ºç½‘æ ¼ç­–ç•¥çš„ç›ˆåˆ©èƒ½åŠ›
- **è®¢å•åˆ†å¸ƒç®—æ³•**: 
  - æŒ‰è·ç¦»å½“å‰ä»·æ ¼çš„è¿œè¿‘æ’åºæ‰€æœ‰ç½‘æ ¼ç‚¹
  - åœ¨ä¸Šæ–¹å’Œä¸‹æ–¹å„åˆ†é… `max_open_orders/2` ä¸ªè®¢å•
  - å¦‚æœæ˜¯å¥‡æ•°ï¼Œä¼˜å…ˆåˆ†é…ç»™è·ç¦»æ›´è¿‘çš„æ–¹å‘

æ ¸å¿ƒçš„æ­¢ç›ˆåŸç†ä¾ç„¶é€‚ç”¨ï¼š**ä»»ä½•ä¸€ä¸ªå¼€ä»“å•æˆäº¤åï¼Œéƒ½å¿…é¡»ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„å¹³ä»“ï¼ˆæ­¢ç›ˆï¼‰å•ã€‚**

1. **æ›´æ–° GridLevel æ•°æ®ç»“æ„**ï¼šä½¿å…¶èƒ½å¤Ÿç®¡ç†æ›´å¤æ‚çš„è®¢å•çŠ¶æ€ã€‚
2. **åˆ›å»ºæ ¸å¿ƒçš„ handle_order_filled å‡½æ•°**ï¼šè¿™æ˜¯æ‰€æœ‰æ­¢ç›ˆé€»è¾‘çš„å…¥å£ï¼Œå®ƒèƒ½å¤„ç†ä»»ä½•æ–¹å‘çš„å¼€ä»“å•æˆäº¤äº‹ä»¶ã€‚
3. **å¼€å‘è¾…åŠ©å‡½æ•°**ï¼šç”¨äºè®¡ç®—æ­¢ç›ˆä»·æ ¼å’Œé‡ç½®ç½‘æ ¼ã€‚
4. **ä¿®æ”¹ manage_grid_orders**ï¼šç¡®ä¿å®ƒåªç®¡ç†é‚£äº›å°šæœªæŒæœ‰ä»“ä½çš„ç½‘æ ¼ã€‚

------



### ä¸€ã€æ•°æ®ç»“æ„æ›´æ–°

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´å¼ºå¤§çš„ GridLevel æ•°æ®ç»“æ„æ¥è·Ÿè¸ªæ¯ä¸ªç½‘æ ¼çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œç‰¹åˆ«æ˜¯å®ƒæ˜¯å¦å·²ç»æŒæœ‰ä»“ä½ã€‚



```
      # ä½äº 3.2.1 æ ¸å¿ƒæ•°æ®ç»“æ„

from dataclasses import dataclass, field
from decimal import Decimal
from typing import Optional, List
import time

@dataclass
class GridLevel:
    """ç½‘æ ¼å±‚çº§æ•°æ®ç»“æ„ (å·²æ›´æ–°ï¼Œæ”¯æŒåŒå‘æŒ‚å•)"""
    level_id: str                    # ç½‘æ ¼å±‚çº§ID
    price: Decimal                   # ç½‘æ ¼ä»·æ ¼
    quantity: Decimal                # ç½‘æ ¼æ•°é‡
    side: str                        # æ–¹å‘: "LONG" æˆ– "SHORT"
    account_type: str                # è´¦æˆ·ç±»å‹: "long_account" æˆ– "short_account"
    
    # è®¢å•çŠ¶æ€
    open_order_id: Optional[str] = None      # å¼€ä»“è®¢å•ID
    close_order_id: Optional[str] = None     # æ­¢ç›ˆå¹³ä»“è®¢å•ID
    
    # çŠ¶æ€æœºï¼Œæ¯”ç®€å•çš„å­—ç¬¦ä¸²æ›´æ¸…æ™°
    # INACTIVE: ç©ºé—²ï¼Œå¯æŒ‚å¼€ä»“å•
    # PENDING_OPEN: å¼€ä»“å•å·²æŒ‚å‡º
    # HOLDING: å·²æŒä»“ï¼Œç­‰å¾…æŒ‚æ­¢ç›ˆå•æˆ–æ­¢ç›ˆå•å·²æŒ‚å‡º
    # PENDING_CLOSE: æ­¢ç›ˆå•å·²æŒ‚å‡º
    status: str = "INACTIVE"                 
    
    # æˆäº¤ä¿¡æ¯
    is_holding: bool = False                 # æ˜ç¡®æ ‡è¯†æ˜¯å¦æŒæœ‰è¯¥å±‚çº§çš„ä»“ä½
    filled_quantity: Decimal = Decimal("0")  # å·²æˆäº¤æ•°é‡
    avg_fill_price: Decimal = Decimal("0")   # å¹³å‡æˆäº¤ä»·æ ¼
    
    # æ—¶é—´æˆ³
    created_time: float = field(default_factory=time.time)
    filled_time: Optional[float] = None      # å¼€ä»“æˆäº¤æ—¶é—´
    closed_time: Optional[float] = None      # å¹³ä»“æˆäº¤æ—¶é—´

# GridStrategy å’Œ DualAccountGridManager ä¿æŒä¸å˜
    
```

**å…³é”®å˜æ›´**ï¼š

- æˆ‘ä»¬ç”¨ä¸€ä¸ªæ›´æ¸…æ™°çš„ status å­—æ®µæ¥ä»£æ›¿ open_order_status å’Œ close_order_statusã€‚
- å¢åŠ äº† is_holding å­—æ®µï¼Œè¿™æ˜¯åŒºåˆ†ä¸€ä¸ªç½‘æ ¼æ˜¯å¦å¯ä»¥ç”¨æ¥æŒ‚å¼€ä»“å•çš„æ ¸å¿ƒæ ‡å¿—ã€‚

------



### äºŒã€æ ¸å¿ƒæ­¢ç›ˆé€»è¾‘ï¼šè®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†

è¿™éƒ¨åˆ†æ˜¯å…¨æ–°çš„å†…å®¹ï¼Œåº”è¯¥è¢«æ·»åŠ åˆ° DualAccountGridManager ç±»ä¸­ã€‚

```
      # ä½äº DualAccountGridManager ç±»ä¸­

async def handle_order_filled(self, account_type: str, order_data: dict):
    """
    å¤„ç†æ‰€æœ‰è®¢å•æˆäº¤äº‹ä»¶ï¼Œæ˜¯å¼€ä»“å’Œæ­¢ç›ˆçš„æ ¸å¿ƒä¸­æ¢ã€‚
    é€‚ç”¨äºåŒå‘æŒ‚å•é€»è¾‘ã€‚
    """
    async with self.sync_lock:
        order_id = order_data['orderId']
        side = order_data['side']  # "BUY" or "SELL"
        position_side = order_data['positionSide']  # "LONG" or "SHORT"
        filled_qty = Decimal(order_data['executedQty'])
        avg_price = Decimal(order_data['avgPrice'])
        
        # è¯†åˆ«è®¢å•ç±»å‹
        is_opening_order = (side == "BUY" and position_side == "LONG") or \
                           (side == "SELL" and position_side == "SHORT")
                           
        is_closing_order = (side == "SELL" and position_side == "LONG") or \
                           (side == "BUY" and position_side == "SHORT")

        if is_opening_order:
            # --- å¼€ä»“å•æˆäº¤ ---
            grid = self.find_grid_by_order_id(order_id, 'open')
            if not grid:
                logger.warning(f"æœªæ‰¾åˆ°ä¸å¼€ä»“è®¢å• {order_id} åŒ¹é…çš„ç½‘æ ¼")
                return

            logger.info(f"âœ… å¼€ä»“æˆäº¤: è´¦æˆ·={account_type}, æ–¹å‘={position_side}, ä»·æ ¼={avg_price}, æ•°é‡={filled_qty}")

            # 1. æ›´æ–°ç½‘æ ¼çŠ¶æ€ä¸ºâ€œå·²æŒä»“â€
            grid.status = "HOLDING"
            grid.is_holding = True
            grid.filled_quantity = filled_qty
            grid.avg_fill_price = avg_price
            grid.filled_time = time.time()
            
            # 2. ã€æ ¸å¿ƒã€‘ç«‹å³ä¸ºè¿™ç¬”æˆäº¤åˆ›å»ºæ­¢ç›ˆå•
            await self.create_take_profit_order(grid)

        elif is_closing_order:
            # --- æ­¢ç›ˆå•æˆäº¤ ---
            grid = self.find_grid_by_order_id(order_id, 'close')
            if not grid:
                logger.warning(f"æœªæ‰¾åˆ°ä¸æ­¢ç›ˆè®¢å• {order_id} åŒ¹é…çš„ç½‘æ ¼")
                return

            pnl = (avg_price - grid.avg_fill_price) * filled_qty if position_side == "LONG" else (grid.avg_fill_price - avg_price) * filled_qty
            logger.info(f"ğŸ’° æ­¢ç›ˆæˆäº¤: è´¦æˆ·={account_type}, æ–¹å‘={position_side}, ä»·æ ¼={avg_price}, åˆ©æ¶¦={pnl:.4f}")

            # 1. ç´¯åŠ å·²å®ç°ç›ˆåˆ©
            self.total_realized_pnl += pnl

            # 2. ã€æ ¸å¿ƒã€‘é‡ç½®ç½‘æ ¼ï¼Œä½¿å…¶å˜å›â€œç©ºé—²â€çŠ¶æ€ï¼Œå¯ä»¥å†æ¬¡è¢«ç”¨äºæŒ‚å¼€ä»“å•
            await self.reset_grid_level(grid)


async def create_take_profit_order(self, filled_grid: GridLevel):
    """ä¸ºä¸€ä¸ªå·²æˆäº¤çš„å¼€ä»“ç½‘æ ¼åˆ›å»ºå¯¹åº”çš„æ­¢ç›ˆè®¢å•"""
    
    # 1. ç¡®å®šæ­¢ç›ˆç›®æ ‡ä»·æ ¼ï¼ˆç›¸é‚»çš„ä¸‹ä¸€ä¸ªç½‘æ ¼ï¼‰
    target_price = self.find_take_profit_price(filled_grid)
    if not target_price:
        logger.warning(f"æ— æ³•ä¸ºä»·æ ¼ä¸º {filled_grid.price} çš„ç½‘æ ¼æ‰¾åˆ°æ­¢ç›ˆç›®æ ‡ï¼Œå¯èƒ½æ˜¯è¾¹ç•Œç½‘æ ¼ã€‚")
        filled_grid.status = "HOLDING" # æ ‡è®°ä¸ºæŒä»“ï¼Œä½†ä¸æŒ‚æ­¢ç›ˆå•
        return

    # 2. ç¡®å®šä¸‹å•è´¦æˆ·å’Œæ–¹å‘
    account = self.long_account if filled_grid.account_type == "long_account" else self.short_account
    close_side = "SELL" if filled_grid.side == "LONG" else "BUY"
    position_side = "LONG" if filled_grid.side == "LONG" else "SHORT"

    try:
        # 3. ä¸‹è¾¾æ­¢ç›ˆè®¢å•ï¼ˆå…³é”®å‚æ•°ï¼šreduce_only=Trueï¼‰
        order = await account.place_limit_order(
            symbol=self.config.symbol,
            side=close_side,
            position_side=position_side,
            quantity=filled_grid.filled_quantity,
            price=target_price,
            reduce_only=True
        )
        
        # 4. æ›´æ–°ç½‘æ ¼çŠ¶æ€
        filled_grid.close_order_id = order['orderId']
        filled_grid.status = "PENDING_CLOSE" # çŠ¶æ€æ›´æ–°ä¸ºâ€œç­‰å¾…å¹³ä»“â€
        
        logger.info(f"åˆ›å»ºæ­¢ç›ˆå•æˆåŠŸ: ç½‘æ ¼ä»·={filled_grid.price}, æ­¢ç›ˆä»·={target_price}, è®¢å•ID={order['orderId']}")

    except Exception as e:
        logger.error(f"åˆ›å»ºæ­¢ç›ˆå•å¤±è´¥: {e}. ç½‘æ ¼ {filled_grid.level_id} ä»å¤„äº HOLDING çŠ¶æ€ã€‚")
        # éœ€è¦æœ‰é‡è¯•æˆ–å‘Šè­¦æœºåˆ¶


def find_take_profit_price(self, filled_grid: GridLevel) -> Optional[Decimal]:
    """æ ¹æ®å½“å‰æˆäº¤çš„ç½‘æ ¼ï¼ŒæŸ¥æ‰¾å…¶æ­¢ç›ˆä»·æ ¼ï¼ˆå³ç›¸é‚»çš„ä¸‹ä¸€ä¸ªç½‘æ ¼ä»·æ ¼ï¼‰"""
    grids = self.grid_strategy.long_grids if filled_grid.account_type == "long_account" else self.grid_strategy.short_grids
    grids.sort(key=lambda g: g.price)
    
    try:
        current_index = [i for i, g in enumerate(grids) if g.level_id == filled_grid.level_id][0]
        
        if filled_grid.side == "LONG":
            if current_index + 1 < len(grids): return grids[current_index + 1].price
        elif filled_grid.side == "SHORT":
            if current_index - 1 >= 0: return grids[current_index - 1].price
    except IndexError:
        logger.error(f"åœ¨ç½‘æ ¼åˆ—è¡¨ä¸­æœªæ‰¾åˆ°IDä¸º {filled_grid.level_id} çš„ç½‘æ ¼")
    return None


async def reset_grid_level(self, closed_grid: GridLevel):
    """å½“ä¸€ä¸ªç½‘æ ¼æ­¢ç›ˆåï¼Œé‡ç½®å…¶çŠ¶æ€ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«é‡æ–°æŒ‚å¼€ä»“å•"""
    logger.info(f"é‡ç½®ç½‘æ ¼å±‚çº§: ä»·æ ¼={closed_grid.price}")
    
    closed_grid.is_holding = False
    closed_grid.status = "INACTIVE"
    closed_grid.filled_quantity = Decimal("0")
    closed_grid.avg_fill_price = Decimal("0")
    closed_grid.filled_time = None
    closed_grid.closed_time = time.time()
    closed_grid.open_order_id = None
    closed_grid.close_order_id = None


def find_grid_by_order_id(self, order_id: str, order_type: str) -> Optional[GridLevel]:
    """é€šè¿‡è®¢å•IDæŸ¥æ‰¾å¯¹åº”çš„ç½‘æ ¼å±‚çº§"""
    attr_to_check = 'open_order_id' if order_type == 'open' else 'close_order_id'
    
    for grid in self.grid_strategy.long_grids + self.grid_strategy.short_grids:
        if getattr(grid, attr_to_check) == order_id:
            return grid
    return None
    
```



------



### ä¸‰ã€æŒ‚å•é€»è¾‘ä¿®æ”¹

ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹æ‚¨æä¾›çš„æŒ‚å•é€»è¾‘ï¼Œè®©å®ƒ**åªå¯¹çŠ¶æ€ä¸º INACTIVE çš„ç½‘æ ¼è¿›è¡Œæ“ä½œ**ï¼Œé¿å…ä¸ºå·²ç»æŒä»“æˆ–å·²æŒ‚å•çš„ç½‘æ ¼é‡å¤æŒ‚å•ã€‚

```
      # ä½äº 3.3.2 åŠ¨æ€ç½‘æ ¼è°ƒæ•´

async def manage_long_buy_orders_bidirectional(self, current_price: Decimal, max_orders: int):
    """ç®¡ç†å¤šå¤´è´¦æˆ·çš„ä¹°å•ï¼ˆå¸‚ä»·ä¸Šæ–¹å’Œä¸‹æ–¹éƒ½æŒ‚ä¹°å•ï¼Œå®ç°åŒå‘è¡¥ä»“ï¼‰"""
    
    # ã€ä¿®æ”¹ã€‘ç­›é€‰æ¡ä»¶å¢åŠ ï¼šåªé€‰æ‹©å°šæœªæŒä»“çš„ç½‘æ ¼
    # è·å–å¸‚ä»·ä¸Šæ–¹çš„ç½‘æ ¼ç‚¹
    above_grids = [
        grid for grid in self.grid_strategy.long_grids 
        if grid.price > current_price and not grid.is_holding
    ]
    above_grids.sort(key=lambda x: x.price)
    
    # è·å–å¸‚ä»·ä¸‹æ–¹çš„ç½‘æ ¼ç‚¹
    below_grids = [
        grid for grid in self.grid_strategy.long_grids 
        if grid.price < current_price and not grid.is_holding
    ]
    below_grids.sort(key=lambda x: x.price, reverse=True)
    
    orders_above = max_orders // 2
    orders_below = max_orders - orders_above
    
    await self.manage_grid_orders(above_grids, orders_above, self.long_account, "ABOVE")
    await self.manage_grid_orders(below_grids, orders_below, self.long_account, "BELOW")


async def manage_short_sell_orders_bidirectional(self, current_price: Decimal, max_orders: int):
    """ç®¡ç†ç©ºå¤´è´¦æˆ·çš„å–å•ï¼ˆå¸‚ä»·ä¸Šæ–¹å’Œä¸‹æ–¹éƒ½æŒ‚å–å•ï¼Œå®ç°åŒå‘è¡¥ä»“ï¼‰"""
    
    # ã€ä¿®æ”¹ã€‘ç­›é€‰æ¡ä»¶å¢åŠ ï¼šåªé€‰æ‹©å°šæœªæŒä»“çš„ç½‘æ ¼
    # è·å–å¸‚ä»·ä¸Šæ–¹çš„ç½‘æ ¼ç‚¹
    above_grids = [
        grid for grid in self.grid_strategy.short_grids 
        if grid.price > current_price and not grid.is_holding
    ]
    above_grids.sort(key=lambda x: x.price)
    
    # è·å–å¸‚ä»·ä¸‹æ–¹çš„ç½‘æ ¼ç‚¹
    below_grids = [
        grid for grid in self.grid_strategy.short_grids 
        if grid.price < current_price and not grid.is_holding
    ]
    below_grids.sort(key=lambda x: x.price, reverse=True)
    
    orders_above = max_orders // 2
    orders_below = max_orders - orders_above
    
    await self.manage_grid_orders(above_grids, orders_above, self.short_account, "ABOVE")
    await self.manage_grid_orders(below_grids, orders_below, self.short_account, "BELOW")


async def manage_grid_orders(self, grids: list, target_count: int, account, direction: str):
    """é€šç”¨çš„ç½‘æ ¼è®¢å•ç®¡ç†å‡½æ•° (å·²æ›´æ–°)"""
    
    # æ£€æŸ¥å½“å‰å·²æŒ‚å‡ºçš„ã€å¼€ä»“å•ã€‘
    active_open_orders = [
        grid for grid in grids 
        if grid.status == "PENDING_OPEN"
    ]
    
    # å¦‚æœæ´»è·ƒè®¢å•å°‘äºç›®æ ‡æ•°é‡ï¼Œæ·»åŠ æ–°è®¢å•
    if len(active_open_orders) < target_count:
        needed_orders = target_count - len(active_open_orders)
        
        # ä»ã€ç©ºé—²ã€‘çš„ç½‘æ ¼ä¸­é€‰æ‹©
        available_grids = [grid for grid in grids if grid.status == "INACTIVE"]

        for grid in available_grids[:needed_orders]:
            # ã€å‡è®¾ã€‘place_grid_orderä¼šä¸‹å•å¹¶æ›´æ–°gridçŠ¶æ€
            await self.place_grid_order(grid, account) 
            logger.info(f"æ¿€æ´»{direction}æ–¹å‘ç½‘æ ¼è®¢å•: ä»·æ ¼={grid.price}, è´¦æˆ·={account.name}")
    
    # å¦‚æœæ´»è·ƒè®¢å•è¶…è¿‡ç›®æ ‡æ•°é‡ï¼Œå–æ¶ˆè·ç¦»æœ€è¿œçš„è®¢å•
    elif len(active_open_orders) > target_count:
        excess_orders = len(active_open_orders) - target_count
        
        # active_open_orders å·²ç»æŒ‰ä»·æ ¼æ’å¥½åºï¼Œæœ«å°¾å°±æ˜¯æœ€è¿œçš„
        orders_to_cancel = active_open_orders[-excess_orders:]
        for grid in orders_to_cancel:
            # ã€å‡è®¾ã€‘cancel_orderä¼šæ’¤å•å¹¶æ›´æ–°gridçŠ¶æ€
            await self.cancel_order(account, grid.open_order_id)
            logger.info(f"å–æ¶ˆ{direction}æ–¹å‘ç½‘æ ¼è®¢å•: ä»·æ ¼={grid.price}, è´¦æˆ·={account.name}")

# ã€æ–°å¢ã€‘ä¸‹å•å’Œæ’¤å•çš„å…·ä½“å®ç°ï¼Œéœ€è¦ä¸GridLevelçŠ¶æ€åŒæ­¥
async def place_grid_order(self, grid: GridLevel, account):
    """ä¸‹å•å¹¶æ›´æ–°ç½‘æ ¼çŠ¶æ€"""
    try:
        # å…·ä½“ä¸‹å•é€»è¾‘ï¼Œå–å†³äºæ‚¨çš„äº¤æ˜“æ‰€APIå°è£…
        order = await account.place_limit_order(...)
        grid.open_order_id = order['orderId']
        grid.status = "PENDING_OPEN"
    except Exception as e:
        logger.error(f"ä¸‹å•å¤±è´¥: {e}")
        grid.status = "INACTIVE" # å¤±è´¥åˆ™æ¢å¤ä¸ºç©ºé—²

async def cancel_order(self, account, order_id):
    """æ’¤å•å¹¶æ›´æ–°å¯¹åº”ç½‘æ ¼çš„çŠ¶æ€"""
    grid = self.find_grid_by_order_id(order_id, 'open')
    try:
        await account.cancel_order(order_id)
        if grid:
            grid.open_order_id = None
            grid.status = "INACTIVE"
    except Exception as e:
        logger.error(f"æ’¤å•å¤±è´¥: {e}")
        # çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´ï¼Œéœ€è¦åŒæ­¥æœºåˆ¶æ¥æ ¡å‡†
    
```



### å››ã€æ€»ç»“ä¸å·¥ä½œæµç¨‹

æ•´ä¸ªç­–ç•¥çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š

1. **åˆå§‹åŒ–**: åˆ›å»ºæ‰€æœ‰ GridLevel å¯¹è±¡ï¼Œåˆå§‹çŠ¶æ€å‡ä¸º INACTIVEã€‚
2. **æŒ‚å¼€ä»“å•**: dynamic_grid_adjustment å¾ªç¯è¿è¡Œã€‚å®ƒä¼šæ£€æŸ¥æ‰€æœ‰ INACTIVE çš„ç½‘æ ¼ï¼Œå¹¶æ ¹æ®åŒå‘æŒ‚å•é€»è¾‘ï¼Œåœ¨å¸‚ä»·ä¸Šä¸‹æ–¹é€‰æ‹© max_open_orders ä¸ªç½‘æ ¼ï¼Œè°ƒç”¨ place_grid_order ä¸‹å¼€ä»“å•ï¼Œå¹¶å°†å®ƒä»¬çš„çŠ¶æ€æ›´æ–°ä¸º PENDING_OPENã€‚
3. **å¼€ä»“æˆäº¤**: äº¤æ˜“æ‰€æ¨é€è®¢å•æˆäº¤æ¶ˆæ¯ã€‚handle_order_filled è¢«è°ƒç”¨ï¼Œè¯†åˆ«å‡ºæ˜¯å¼€ä»“å•æˆäº¤ã€‚
4. **æŒ‚æ­¢ç›ˆå•**: handle_order_filled å°†è¯¥ç½‘æ ¼çŠ¶æ€æ›´æ–°ä¸º HOLDINGï¼Œç„¶åç«‹å³è°ƒç”¨ create_take_profit_orderï¼Œåœ¨ç›¸é‚»ç½‘æ ¼æŒ‚ä¸€ä¸ªæ­¢ç›ˆå•ï¼Œå¹¶å°†çŠ¶æ€æ›´æ–°ä¸º PENDING_CLOSEã€‚
5. **æ­¢ç›ˆæˆäº¤**: äº¤æ˜“æ‰€å†æ¬¡æ¨é€æˆäº¤æ¶ˆæ¯ã€‚handle_order_filled è¯†åˆ«å‡ºæ˜¯å¹³ä»“å•æˆäº¤ã€‚
6. **ç½‘æ ¼é‡ç½®**: handle_order_filled è°ƒç”¨ reset_grid_levelï¼Œå°†è¯¥ç½‘æ ¼çš„æ‰€æœ‰ä¿¡æ¯æ¸…ç©ºï¼ŒçŠ¶æ€é‡æ–°è®¾ç½®ä¸º INACTIVEã€‚
7. **å¾ªç¯**: è¿™ä¸ªçŠ¶æ€å˜ä¸º INACTIVE çš„ç½‘æ ¼ï¼Œåœ¨ä¸‹ä¸€æ¬¡ dynamic_grid_adjustment è¿è¡Œæ—¶ï¼Œåˆå¯ä»¥è¢«é‡æ–°é€‰ä¸­ç”¨æ¥æŒ‚å¼€ä»“å•äº†ã€‚

è¿™ä¸ªæµç¨‹å®Œæ•´åœ°å®ç°äº†åœ¨â€œåŒå‘è¡¥ä»“â€ç­–ç•¥åŸºç¡€ä¸Šçš„è‡ªåŠ¨åŒ–æ­¢ç›ˆï¼Œç¡®ä¿äº†æ¯ä¸€ç¬”ä»“ä½éƒ½æœ‰å¯¹åº”çš„å¹³ä»“é€»è¾‘ï¼Œå¹¶ä¸”ç½‘æ ¼å¯ä»¥è¢«å¾ªç¯åˆ©ç”¨ã€‚