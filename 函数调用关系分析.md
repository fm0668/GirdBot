# åŒè´¦æˆ·å¯¹å†²ç½‘æ ¼ç­–ç•¥ - å‡½æ•°è°ƒç”¨å…³ç³»åˆ†æ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºPythonçš„åŒè´¦æˆ·å¯¹å†²ç½‘æ ¼äº¤æ˜“ç­–ç•¥ç³»ç»Ÿï¼Œé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå…·æœ‰æ¸…æ™°çš„åˆ†å±‚æ¶æ„ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å±‚æ¬¡

```
åŒè´¦æˆ·å¯¹å†²ç½‘æ ¼ç­–ç•¥ç³»ç»Ÿ
â”œâ”€â”€ ä¸»ç­–ç•¥å±‚ (hedge_grid_strategy.py)
â”œâ”€â”€ é…ç½®ç®¡ç†å±‚ (config/)
â”œâ”€â”€ è´¦æˆ·ç®¡ç†å±‚ (core/dual_account_manager.py)
â”œâ”€â”€ ç½‘æ ¼è®¡ç®—å±‚ (core/atr_calculator.py, grid_calculator.py, shared_grid_engine.py)
â”œâ”€â”€ æ‰§è¡Œå™¨æ¶æ„å±‚ (core/hedge_grid_executor.py, long/short_account_executor.py)
â”œâ”€â”€ ç›‘æ§ç®¡ç†å±‚ (core/hedge_monitor.py, risk_hedge_controller.py)
â””â”€â”€ å·¥å…·åº“å±‚ (utils/)
```

## ğŸ”‘ æ ¸å¿ƒå‡½æ•°è¯†åˆ«

### 1. ä¸»è¦å…¥å£å‡½æ•°

| å‡½æ•°å | ä½ç½® | ä½œç”¨ | é‡è¦æ€§ |
|--------|------|------|--------|
| `main()` | hedge_grid_strategy.py | ç³»ç»Ÿä¸»å…¥å£ç‚¹ï¼Œåè°ƒæ‰€æœ‰æ¨¡å—åˆå§‹åŒ–å’Œè¿è¡Œ | â­â­â­â­â­ |
| `HedgeGridStrategy.main()` | hedge_grid_strategy.py | ç­–ç•¥ä¸»æ§åˆ¶æµç¨‹ | â­â­â­â­â­ |
| `initialize_system()` | hedge_grid_strategy.py | ç³»ç»Ÿç»„ä»¶åˆå§‹åŒ– | â­â­â­â­ |
| `start_strategy()` | hedge_grid_strategy.py | å¯åŠ¨ç­–ç•¥æ‰§è¡Œ | â­â­â­â­ |

### 2. å…³é”®å·¥å…·å‡½æ•°å’Œè¾…åŠ©å‡½æ•°

| å‡½æ•°å | ä½ç½® | ä½œç”¨ | é‡è¦æ€§ |
|--------|------|------|--------|
| `DualAccountManager.initialize_accounts()` | core/dual_account_manager.py | åˆå§‹åŒ–åŒè´¦æˆ·è¿æ¥ | â­â­â­â­ |
| `SharedGridEngine.initialize_grid_parameters()` | core/shared_grid_engine.py | åˆå§‹åŒ–ç½‘æ ¼å‚æ•° | â­â­â­â­ |
| `ExecutorFactory.create_executors()` | core/executor_factory.py | åˆ›å»ºæ‰§è¡Œå™¨å®ä¾‹ | â­â­â­ |
| `HedgeGridExecutor.control_loop()` | core/hedge_grid_executor.py | æ‰§è¡Œå™¨ä¸»æ§åˆ¶å¾ªç¯ | â­â­â­â­ |
| `SyncController.start_hedge_strategy()` | core/sync_controller.py | å¯åŠ¨åŒè´¦æˆ·åŒæ­¥ç­–ç•¥ | â­â­â­â­ |

### 3. ç›‘æ§å’Œé£é™©æ§åˆ¶å‡½æ•°

| å‡½æ•°å | ä½ç½® | ä½œç”¨ | é‡è¦æ€§ |
|--------|------|------|--------|
| `HedgeMonitor.start_monitoring()` | core/hedge_monitor.py | å¯åŠ¨ç³»ç»Ÿç›‘æ§ | â­â­â­ |
| `RiskHedgeController.start_risk_monitoring()` | core/risk_hedge_controller.py | å¯åŠ¨é£é™©ç›‘æ§ | â­â­â­ |
| `collect_metrics()` | core/hedge_monitor.py | æ”¶é›†ç›‘æ§æŒ‡æ ‡ | â­â­ |
| `calculate_risk_metrics()` | core/risk_hedge_controller.py | è®¡ç®—é£é™©æŒ‡æ ‡ | â­â­â­ |

## ğŸ”„ è°ƒç”¨é“¾è·¯åˆ†æ

### ä¸»è¦è°ƒç”¨æµç¨‹

```
main() [hedge_grid_strategy.py]
â”œâ”€â”€ HedgeGridStrategy.__init__()
â”œâ”€â”€ HedgeGridStrategy.main()
    â”œâ”€â”€ setup_signal_handlers()
    â”œâ”€â”€ initialize_system()
    â”‚   â”œâ”€â”€ _load_configurations()
    â”‚   â”‚   â”œâ”€â”€ DualAccountConfig.load_from_env()
    â”‚   â”‚   â””â”€â”€ GridExecutorConfig.load_from_env()
    â”‚   â”œâ”€â”€ _initialize_account_manager()
    â”‚   â”‚   â””â”€â”€ DualAccountManager.initialize_accounts()
    â”‚   â”‚       â”œâ”€â”€ _initialize_single_account() [Aè´¦æˆ·]
    â”‚   â”‚       â”œâ”€â”€ _initialize_single_account() [Bè´¦æˆ·]
    â”‚   â”‚       â””â”€â”€ _update_account_status()
    â”‚   â”œâ”€â”€ _initialize_grid_engine()
    â”‚   â”‚   â””â”€â”€ SharedGridEngine.initialize_grid_parameters()
    â”‚   â”‚       â”œâ”€â”€ ATRCalculator.calculate_atr_channel()
    â”‚   â”‚       â”œâ”€â”€ GridCalculator.calculate_grid_parameters()
    â”‚   â”‚       â””â”€â”€ generate_grid_levels()
    â”‚   â”œâ”€â”€ _create_executors()
    â”‚   â”‚   â””â”€â”€ ExecutorFactory.create_executors()
    â”‚   â”‚       â”œâ”€â”€ create_dual_account_strategy()
    â”‚   â”‚       â”‚   â”œâ”€â”€ LongAccountExecutor.__init__()
    â”‚   â”‚       â”‚   â”œâ”€â”€ ShortAccountExecutor.__init__()
    â”‚   â”‚       â”‚   â””â”€â”€ SyncController.__init__()
    â”‚   â”‚       â””â”€â”€ create_single_account_strategy()
    â”‚   â”œâ”€â”€ _initialize_monitoring()
    â”‚   â”‚   â”œâ”€â”€ HedgeMonitor.__init__()
    â”‚   â”‚   â””â”€â”€ RiskHedgeController.__init__()
    â”‚   â””â”€â”€ _initialize_risk_control()
    â”œâ”€â”€ start_strategy()
    â”‚   â”œâ”€â”€ HedgeMonitor.start_monitoring()
    â”‚   â”œâ”€â”€ RiskHedgeController.start_risk_monitoring()
    â”‚   â””â”€â”€ SyncController.start_hedge_strategy()
    â”‚       â”œâ”€â”€ LongAccountExecutor.start()
    â”‚       â”œâ”€â”€ ShortAccountExecutor.start()
    â”‚       â”œâ”€â”€ sync_monitoring_loop()
    â”‚       â””â”€â”€ risk_monitoring_loop()
    â”œâ”€â”€ run_main_loop()
    â””â”€â”€ shutdown_strategy()
```

### æ‰§è¡Œå™¨æ§åˆ¶å¾ªç¯

```
HedgeGridExecutor.control_loop()
â”œâ”€â”€ _update_grid_levels()
â”œâ”€â”€ _update_order_status()
â”œâ”€â”€ get_open_orders_to_create()
â”œâ”€â”€ get_close_orders_to_create()
â”œâ”€â”€ _get_orders_to_cancel()
â””â”€â”€ execute_order_operations()
    â”œâ”€â”€ _place_open_order() [æŠ½è±¡æ–¹æ³•]
    â”œâ”€â”€ _place_close_order() [æŠ½è±¡æ–¹æ³•]
    â””â”€â”€ _cancel_order()
```

### ç›‘æ§å¾ªç¯

```
HedgeMonitor._monitoring_loop()
â”œâ”€â”€ collect_metrics()
â”‚   â”œâ”€â”€ DualAccountManager.get_dual_account_status()
â”‚   â”œâ”€â”€ HedgeGridExecutor.get_status()
â”‚   â””â”€â”€ è®¡ç®—æ€§èƒ½æŒ‡æ ‡
â”œâ”€â”€ check_alerts()
â””â”€â”€ _process_alerts()

RiskHedgeController._risk_monitoring_loop()
â”œâ”€â”€ calculate_risk_metrics()
â”œâ”€â”€ check_risk_limits()
â”œâ”€â”€ should_trigger_stop_loss()
â””â”€â”€ emergency_shutdown()
```

## ğŸ”— æ¨¡å—é—´ä¾èµ–å…³ç³»

### Importä¾èµ–å›¾

```mermaid
graph TD
    A[hedge_grid_strategy.py] --> B[config/dual_account_config.py]
    A --> C[config/grid_executor_config.py]
    A --> D[core/dual_account_manager.py]
    A --> E[core/shared_grid_engine.py]
    A --> F[core/executor_factory.py]
    A --> G[core/hedge_monitor.py]
    A --> H[core/risk_hedge_controller.py]
    A --> I[utils/logger.py]
    A --> J[utils/exceptions.py]
    
    F --> K[core/hedge_grid_executor.py]
    F --> L[core/long_account_executor.py]
    F --> M[core/short_account_executor.py]
    F --> N[core/sync_controller.py]
    
    E --> O[core/atr_calculator.py]
    E --> P[core/grid_calculator.py]
    
    D --> Q[utils/order_tracker.py]
    D --> I
    D --> J
    
    K --> I
    K --> J
    K --> Q
    
    G --> I
    G --> J
    H --> I
    H --> J
    
    style A fill:#ff9999
    style D fill:#99ccff
    style E fill:#99ff99
    style F fill:#ffcc99
```

## ğŸ“Š å‡½æ•°é‡è¦æ€§æ’åº

### æŒ‰é‡è¦æ€§æ’åºçš„å‡½æ•°åˆ—è¡¨

1. **ç³»ç»Ÿçº§æ ¸å¿ƒå‡½æ•°** (â­â­â­â­â­)
   - `main()` - ç³»ç»Ÿå…¥å£ç‚¹
   - `HedgeGridStrategy.main()` - ä¸»æ§åˆ¶æµç¨‹
   - `initialize_system()` - ç³»ç»Ÿåˆå§‹åŒ–

2. **ä¸šåŠ¡æ ¸å¿ƒå‡½æ•°** (â­â­â­â­)
   - `DualAccountManager.initialize_accounts()` - è´¦æˆ·åˆå§‹åŒ–
   - `SharedGridEngine.initialize_grid_parameters()` - ç½‘æ ¼å‚æ•°åˆå§‹åŒ–
   - `HedgeGridExecutor.control_loop()` - æ‰§è¡Œå™¨ä¸»å¾ªç¯
   - `SyncController.start_hedge_strategy()` - åŒæ­¥ç­–ç•¥å¯åŠ¨
   - `start_strategy()` - ç­–ç•¥å¯åŠ¨

3. **åŠŸèƒ½æ”¯æŒå‡½æ•°** (â­â­â­)
   - `ExecutorFactory.create_executors()` - æ‰§è¡Œå™¨åˆ›å»º
   - `HedgeMonitor.start_monitoring()` - ç›‘æ§å¯åŠ¨
   - `RiskHedgeController.start_risk_monitoring()` - é£é™©ç›‘æ§å¯åŠ¨
   - `calculate_risk_metrics()` - é£é™©æŒ‡æ ‡è®¡ç®—
   - `DualAccountManager.pre_flight_checks()` - é¢„æ£€æŸ¥

4. **å·¥å…·è¾…åŠ©å‡½æ•°** (â­â­)
   - `collect_metrics()` - æŒ‡æ ‡æ”¶é›†
   - `ATRCalculator.calculate_atr_channel()` - ATRè®¡ç®—
   - `GridCalculator.calculate_grid_parameters()` - ç½‘æ ¼å‚æ•°è®¡ç®—
   - `OrderTracker.add_order()` - è®¢å•è·Ÿè¸ª

5. **é…ç½®å’Œå·¥å…·å‡½æ•°** (â­)
   - `DualAccountConfig.load_from_env()` - é…ç½®åŠ è½½
   - `setup_logger()` - æ—¥å¿—è®¾ç½®
   - `round_to_precision()` - ç²¾åº¦å¤„ç†
   - `validate_trading_pair()` - äº¤æ˜“å¯¹éªŒè¯

## ğŸ”„ å¾ªç¯è°ƒç”¨å’Œé€’å½’å…³ç³»

### ä¸»è¦å¾ªç¯è°ƒç”¨

1. **ä¸»è¿è¡Œå¾ªç¯**
   - `run_main_loop()` â†’ `_log_status_summary()` â†’ å¾ªç¯ç­‰å¾…

2. **æ‰§è¡Œå™¨æ§åˆ¶å¾ªç¯**
   - `control_loop()` â†’ è®¢å•å¤„ç† â†’ `asyncio.sleep()` â†’ å¾ªç¯

3. **ç›‘æ§å¾ªç¯**
   - `_monitoring_loop()` â†’ `collect_metrics()` â†’ `check_alerts()` â†’ å¾ªç¯
   - `_risk_monitoring_loop()` â†’ `calculate_risk_metrics()` â†’ `check_risk_limits()` â†’ å¾ªç¯

4. **åŒæ­¥æ§åˆ¶å¾ªç¯**
   - `sync_monitoring_loop()` â†’ `check_sync_status()` â†’ å¾ªç¯
   - `risk_monitoring_loop()` â†’ `check_hedge_risk()` â†’ å¾ªç¯

### é€’å½’å…³ç³»

- **é”™è¯¯é‡è¯•æœºåˆ¶**: å¤§éƒ¨åˆ†å¼‚æ­¥å‡½æ•°éƒ½åŒ…å«é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
- **çŠ¶æ€æ›´æ–°é“¾**: `_update_account_status()` â†’ `get_dual_account_status()` â†’ çŠ¶æ€ä¼ æ’­

## ğŸ”§ ç´§è€¦åˆå’Œæ¾è€¦åˆåˆ†æ

### ç´§è€¦åˆéƒ¨åˆ†
- `HedgeGridStrategy` ä¸æ‰€æœ‰æ ¸å¿ƒæ¨¡å—ç´§å¯†è€¦åˆ
- `DualAccountManager` ä¸äº¤æ˜“æ‰€APIç´§å¯†è€¦åˆ
- æ‰§è¡Œå™¨ä¸ç½‘æ ¼å¼•æ“ç´§å¯†è€¦åˆ

### æ¾è€¦åˆéƒ¨åˆ†
- é…ç½®ç®¡ç†æ¨¡å—ç‹¬ç«‹æ€§å¼º
- å·¥å…·å‡½æ•°åº“å®Œå…¨ç‹¬ç«‹
- ç›‘æ§æ¨¡å—ç›¸å¯¹ç‹¬ç«‹
- å¼‚å¸¸å¤„ç†ç³»ç»Ÿç‹¬ç«‹

## ğŸ“ˆ å¼‚æ­¥è°ƒç”¨æ¨¡å¼

ç³»ç»Ÿå¤§é‡ä½¿ç”¨å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼š
- æ‰€æœ‰æ ¸å¿ƒä¸šåŠ¡å‡½æ•°éƒ½æ˜¯å¼‚æ­¥å‡½æ•°
- ä½¿ç”¨`asyncio.create_task()`åˆ›å»ºå¹¶å‘ä»»åŠ¡
- ä½¿ç”¨`asyncio.sleep()`å®ç°éé˜»å¡ç­‰å¾…
- ä½¿ç”¨`async with`è¿›è¡Œèµ„æºç®¡ç†

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†æœºåˆ¶

- åˆ†å±‚å¼‚å¸¸å¤„ç†ï¼šæ¯å±‚éƒ½æœ‰å¯¹åº”çš„å¼‚å¸¸ç±»å‹
- ç»Ÿä¸€é”™è¯¯è®°å½•ï¼šé€šè¿‡loggerè®°å½•æ‰€æœ‰é”™è¯¯
- ä¼˜é›…é™çº§ï¼šå…³é”®é”™è¯¯è§¦å‘ç´§æ€¥åœæ­¢æœºåˆ¶
- é‡è¯•æœºåˆ¶ï¼šç½‘ç»œç›¸å…³æ“ä½œå…·å¤‡é‡è¯•èƒ½åŠ›

## ğŸ“Š è¯¦ç»†è°ƒç”¨å…³ç³»å›¾è¡¨

### ç³»ç»Ÿåˆå§‹åŒ–æµç¨‹å›¾

```mermaid
graph TD
    A[mainå‡½æ•°å¯åŠ¨] --> B[HedgeGridStrategyåˆå§‹åŒ–]
    B --> C[åŠ è½½é…ç½®]
    C --> D[åˆå§‹åŒ–è´¦æˆ·ç®¡ç†å™¨]
    D --> E[åˆå§‹åŒ–ç½‘æ ¼å¼•æ“]
    E --> F[åˆ›å»ºæ‰§è¡Œå™¨]
    F --> G[åˆå§‹åŒ–ç›‘æ§ç³»ç»Ÿ]
    G --> H[å¯åŠ¨ç­–ç•¥]
    H --> I[è¿è¡Œä¸»å¾ªç¯]

    C --> C1[DualAccountConfig.load_from_env]
    C --> C2[GridExecutorConfig.load_from_env]

    D --> D1[åˆ›å»ºäº¤æ˜“æ‰€è¿æ¥A]
    D --> D2[åˆ›å»ºäº¤æ˜“æ‰€è¿æ¥B]
    D --> D3[éªŒè¯APIæƒé™]
    D --> D4[æ‰§è¡Œé¢„æ£€æŸ¥]

    E --> E1[ATRè®¡ç®—å™¨åˆå§‹åŒ–]
    E --> E2[ç½‘æ ¼å‚æ•°è®¡ç®—]
    E --> E3[ç”Ÿæˆç½‘æ ¼å±‚çº§]

    F --> F1[åˆ›å»ºå¤šå¤´æ‰§è¡Œå™¨]
    F --> F2[åˆ›å»ºç©ºå¤´æ‰§è¡Œå™¨]
    F --> F3[åˆ›å»ºåŒæ­¥æ§åˆ¶å™¨]

    G --> G1[å¯åŠ¨ç³»ç»Ÿç›‘æ§]
    G --> G2[å¯åŠ¨é£é™©æ§åˆ¶]

    H --> H1[å¯åŠ¨æ‰§è¡Œå™¨]
    H --> H2[å¯åŠ¨ç›‘æ§å¾ªç¯]
    H --> H3[å¯åŠ¨é£é™©ç›‘æ§]
```

### æ‰§è¡Œå™¨è¿è¡Œæµç¨‹å›¾

```mermaid
graph TD
    A[æ‰§è¡Œå™¨å¯åŠ¨] --> B[è¿›å…¥æ§åˆ¶å¾ªç¯]
    B --> C[æ›´æ–°ç½‘æ ¼å±‚çº§]
    C --> D[æ›´æ–°è®¢å•çŠ¶æ€]
    D --> E[è·å–å¾…åˆ›å»ºè®¢å•]
    E --> F[è·å–å¾…å–æ¶ˆè®¢å•]
    F --> G[æ‰§è¡Œè®¢å•æ“ä½œ]
    G --> H[ç­‰å¾…ä¸‹ä¸ªå‘¨æœŸ]
    H --> B

    E --> E1[è·å–å¼€ä»“è®¢å•]
    E --> E2[è·å–å¹³ä»“è®¢å•]

    G --> G1[ä¸‹å¼€ä»“è®¢å•]
    G --> G2[ä¸‹å¹³ä»“è®¢å•]
    G --> G3[å–æ¶ˆè®¢å•]

    G1 --> G1A[å¤šå¤´æ‰§è¡Œå™¨ä¹°å…¥]
    G1 --> G1B[ç©ºå¤´æ‰§è¡Œå™¨å–å‡º]

    G2 --> G2A[å¤šå¤´æ‰§è¡Œå™¨å–å‡º]
    G2 --> G2B[ç©ºå¤´æ‰§è¡Œå™¨ä¹°å…¥]
```

### ç›‘æ§ç³»ç»Ÿæµç¨‹å›¾

```mermaid
graph TD
    A[ç›‘æ§ç³»ç»Ÿå¯åŠ¨] --> B[åˆå§‹åŒ–åŸºå‡†æ•°æ®]
    B --> C[è¿›å…¥ç›‘æ§å¾ªç¯]
    C --> D[æ”¶é›†ç³»ç»ŸæŒ‡æ ‡]
    D --> E[æ£€æŸ¥å‘Šè­¦æ¡ä»¶]
    E --> F[å¤„ç†å‘Šè­¦äº‹ä»¶]
    F --> G[ç­‰å¾…ä¸‹ä¸ªå‘¨æœŸ]
    G --> C

    D --> D1[è·å–è´¦æˆ·çŠ¶æ€]
    D --> D2[è·å–æ‰§è¡Œå™¨çŠ¶æ€]
    D --> D3[è®¡ç®—æ€§èƒ½æŒ‡æ ‡]
    D --> D4[è¯„ä¼°é£é™©çº§åˆ«]

    E --> E1[æ£€æŸ¥å›æ’¤å‘Šè­¦]
    E --> E2[æ£€æŸ¥ä½™é¢å·®å¼‚]
    E --> E3[æ£€æŸ¥é£é™©çº§åˆ«]
    E --> E4[æ£€æŸ¥äº¤æ˜“æ´»åŠ¨]

    F --> F1[è®°å½•å‘Šè­¦æ—¥å¿—]
    F --> F2[å‘é€é€šçŸ¥]
    F --> F3[è§¦å‘é£é™©æ§åˆ¶]
```

### é£é™©æ§åˆ¶æµç¨‹å›¾

```mermaid
graph TD
    A[é£é™©æ§åˆ¶å¯åŠ¨] --> B[è¿›å…¥é£é™©ç›‘æ§å¾ªç¯]
    B --> C[è®¡ç®—é£é™©æŒ‡æ ‡]
    C --> D[æ£€æŸ¥é£é™©é™åˆ¶]
    D --> E{æ˜¯å¦è¿åé™åˆ¶?}
    E -->|æ˜¯| F[å¤„ç†é£é™©è¿è§„]
    E -->|å¦| G[æ£€æŸ¥æ­¢æŸæ¡ä»¶]
    G --> H{æ˜¯å¦è§¦å‘æ­¢æŸ?}
    H -->|æ˜¯| I[æ‰§è¡Œç´§æ€¥åœæ­¢]
    H -->|å¦| J[ç­‰å¾…ä¸‹ä¸ªå‘¨æœŸ]
    J --> B

    C --> C1[è®¡ç®—å‡€ä»“ä½]
    C --> C2[è®¡ç®—æ€»æ•å£]
    C --> C3[è®¡ç®—æ æ†æ¯”ç‡]
    C --> C4[è®¡ç®—å›æ’¤ç™¾åˆ†æ¯”]

    F --> F1[è®°å½•é£é™©äº‹ä»¶]
    F --> F2[è°ƒæ•´ä»“ä½]
    F --> F3[æš‚åœæ–°è®¢å•]

    I --> I1[åœæ­¢æ‰€æœ‰æ‰§è¡Œå™¨]
    I --> I2[å–æ¶ˆæ‰€æœ‰è®¢å•]
    I --> I3[å¹³ä»“æ‰€æœ‰æŒä»“]
```

## ğŸ”§ å…³é”®å‡½æ•°è¯¦ç»†åˆ†æ

### 1. ç³»ç»Ÿåˆå§‹åŒ–å‡½æ•°

**`initialize_system()` è°ƒç”¨é“¾:**
```
initialize_system()
â”œâ”€â”€ _load_configurations()
â”‚   â”œâ”€â”€ DualAccountConfig.load_from_env()
â”‚   â””â”€â”€ GridExecutorConfig.load_from_env()
â”œâ”€â”€ _initialize_account_manager()
â”‚   â””â”€â”€ DualAccountManager.initialize_accounts()
â”‚       â”œâ”€â”€ _initialize_single_account('A')
â”‚       â”œâ”€â”€ _initialize_single_account('B')
â”‚       â”œâ”€â”€ _check_api_permissions()
â”‚       â””â”€â”€ pre_flight_checks()
â”œâ”€â”€ _initialize_grid_engine()
â”‚   â””â”€â”€ SharedGridEngine.initialize_grid_parameters()
â”‚       â”œâ”€â”€ ATRCalculator.calculate_atr_channel()
â”‚       â”œâ”€â”€ GridCalculator.calculate_grid_parameters()
â”‚       â””â”€â”€ generate_grid_levels()
â”œâ”€â”€ _create_executors()
â”‚   â””â”€â”€ ExecutorFactory.create_executors()
â”œâ”€â”€ _initialize_monitoring()
â”‚   â”œâ”€â”€ HedgeMonitor.__init__()
â”‚   â””â”€â”€ RiskHedgeController.__init__()
â””â”€â”€ _initialize_risk_control()
```

### 2. è´¦æˆ·ç®¡ç†æ ¸å¿ƒå‡½æ•°

**`DualAccountManager.initialize_accounts()` è°ƒç”¨é“¾:**
```
initialize_accounts()
â”œâ”€â”€ _initialize_single_account('A')
â”‚   â”œâ”€â”€ åˆ›å»ºccxtäº¤æ˜“æ‰€å®ä¾‹
â”‚   â”œâ”€â”€ load_markets()
â”‚   â”œâ”€â”€ fetch_balance()
â”‚   â””â”€â”€ _check_api_permissions()
â”œâ”€â”€ _initialize_single_account('B')
â”‚   â”œâ”€â”€ åˆ›å»ºccxtäº¤æ˜“æ‰€å®ä¾‹
â”‚   â”œâ”€â”€ load_markets()
â”‚   â”œâ”€â”€ fetch_balance()
â”‚   â””â”€â”€ _check_api_permissions()
â””â”€â”€ _update_account_status()
    â”œâ”€â”€ fetch_positions()
    â”œâ”€â”€ fetch_open_orders()
    â””â”€â”€ æ›´æ–°AccountStatus
```

### 3. ç½‘æ ¼å¼•æ“æ ¸å¿ƒå‡½æ•°

**`SharedGridEngine.initialize_grid_parameters()` è°ƒç”¨é“¾:**
```
initialize_grid_parameters()
â”œâ”€â”€ ATRCalculator.calculate_atr_channel()
â”‚   â”œâ”€â”€ fetch_ohlcv()
â”‚   â”œâ”€â”€ calculate_true_range()
â”‚   â”œâ”€â”€ calculate_atr()
â”‚   â””â”€â”€ calculate_channel_bounds()
â”œâ”€â”€ GridCalculator.calculate_grid_parameters()
â”‚   â”œâ”€â”€ calculate_grid_spacing()
â”‚   â”œâ”€â”€ calculate_grid_levels()
â”‚   â””â”€â”€ calculate_position_sizes()
â””â”€â”€ generate_grid_levels()
    â”œâ”€â”€ ç”Ÿæˆå¤šå¤´ç½‘æ ¼å±‚çº§
    â””â”€â”€ ç”Ÿæˆç©ºå¤´ç½‘æ ¼å±‚çº§
```

### 4. æ‰§è¡Œå™¨æ ¸å¿ƒå‡½æ•°

**`HedgeGridExecutor.control_loop()` è°ƒç”¨é“¾:**
```
control_loop()
â”œâ”€â”€ _update_grid_levels()
â”‚   â””â”€â”€ SharedGridEngine.get_current_grid_data()
â”œâ”€â”€ _update_order_status()
â”‚   â”œâ”€â”€ fetch_open_orders()
â”‚   â””â”€â”€ OrderTracker.update_order_status()
â”œâ”€â”€ get_open_orders_to_create()
â”‚   â”œâ”€â”€ _get_current_price()
â”‚   â””â”€â”€ _should_place_order_at_level()
â”œâ”€â”€ get_close_orders_to_create()
â”‚   â””â”€â”€ æ£€æŸ¥å·²æˆäº¤è®¢å•
â”œâ”€â”€ _get_orders_to_cancel()
â”‚   â””â”€â”€ æ£€æŸ¥è¿‡æœŸè®¢å•
â””â”€â”€ execute_order_operations()
    â”œâ”€â”€ _place_open_order() [æŠ½è±¡æ–¹æ³•]
    â”œâ”€â”€ _place_close_order() [æŠ½è±¡æ–¹æ³•]
    â””â”€â”€ _cancel_order()
```

## ğŸ“ˆ æ€§èƒ½å…³é”®è·¯å¾„

### é«˜é¢‘è°ƒç”¨è·¯å¾„
1. **è®¢å•å¤„ç†è·¯å¾„**: `control_loop()` â†’ `execute_order_operations()` â†’ äº¤æ˜“æ‰€API
2. **çŠ¶æ€æ›´æ–°è·¯å¾„**: `_update_order_status()` â†’ `fetch_open_orders()` â†’ çŠ¶æ€åŒæ­¥
3. **ä»·æ ¼è·å–è·¯å¾„**: `_get_current_price()` â†’ `fetch_ticker()` â†’ ä»·æ ¼åˆ¤æ–­

### èµ„æºå¯†é›†å‹æ“ä½œ
1. **ç½‘æ ¼å‚æ•°è®¡ç®—**: ATRè®¡ç®—å’Œç½‘æ ¼å±‚çº§ç”Ÿæˆ
2. **è´¦æˆ·çŠ¶æ€åŒæ­¥**: åŒè´¦æˆ·ä½™é¢å’ŒæŒä»“æŸ¥è¯¢
3. **é£é™©æŒ‡æ ‡è®¡ç®—**: å®æ—¶é£é™©è¯„ä¼°å’Œç›‘æ§

## ğŸ”„ å¼‚æ­¥å¹¶å‘æ¨¡å¼

### ä¸»è¦å¹¶å‘ä»»åŠ¡
```python
# ä¸»è¦å¼‚æ­¥ä»»åŠ¡åˆ›å»ºæ¨¡å¼
self._monitor_task = asyncio.create_task(self._monitoring_loop())
self._risk_task = asyncio.create_task(self._risk_monitoring_loop())
self._sync_task = asyncio.create_task(self.sync_monitoring_loop())
self._health_check_task = asyncio.create_task(self.health_check_loop())
```

### åŒæ­¥æ§åˆ¶æœºåˆ¶
- **è¿æ¥é”**: `async with self._connection_lock`
- **ä½™é¢é”**: `async with self._balance_lock`
- **è®¢å•é”**: é˜²æ­¢è®¢å•æ“ä½œå†²çª

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### æ€§èƒ½ä¼˜åŒ–ç‚¹
1. **ç¼“å­˜æœºåˆ¶**: ä»·æ ¼æ•°æ®å’Œè´¦æˆ·çŠ¶æ€ç¼“å­˜
2. **æ‰¹é‡æ“ä½œ**: è®¢å•æ‰¹é‡å¤„ç†å’ŒçŠ¶æ€æ‰¹é‡æ›´æ–°
3. **è¿æ¥æ± **: äº¤æ˜“æ‰€è¿æ¥å¤ç”¨
4. **å¼‚æ­¥ä¼˜åŒ–**: å‡å°‘ä¸å¿…è¦çš„awaitè°ƒç”¨

### æ¶æ„æ”¹è¿›ç‚¹
1. **è§£è€¦åˆ**: å‡å°‘æ¨¡å—é—´çš„ç›´æ¥ä¾èµ–
2. **æ’ä»¶åŒ–**: æ”¯æŒä¸åŒäº¤æ˜“æ‰€çš„æ’ä»¶å¼æ¥å…¥
3. **é…ç½®çƒ­æ›´æ–°**: æ”¯æŒè¿è¡Œæ—¶é…ç½®ä¿®æ”¹
4. **çŠ¶æ€æŒä¹…åŒ–**: ç³»ç»ŸçŠ¶æ€çš„æŒä¹…åŒ–å­˜å‚¨

## ğŸ“‹ æ€»ç»“

### ç³»ç»Ÿç‰¹ç‚¹
- **åˆ†å±‚æ¶æ„**: æ¸…æ™°çš„6å±‚æ¶æ„è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»æ˜ç¡®
- **å¼‚æ­¥é©±åŠ¨**: å…¨é¢é‡‡ç”¨asyncioå¼‚æ­¥ç¼–ç¨‹æ¨¡å¼
- **æ¨¡å—åŒ–è®¾è®¡**: é«˜å†…èšä½è€¦åˆçš„æ¨¡å—ç»„ç»‡
- **å®Œå–„ç›‘æ§**: å®æ—¶ç›‘æ§å’Œé£é™©æ§åˆ¶æœºåˆ¶
- **å®¹é”™å¤„ç†**: å¤šå±‚æ¬¡çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

### å…³é”®è°ƒç”¨è·¯å¾„
1. **ç³»ç»Ÿå¯åŠ¨**: `main()` â†’ `initialize_system()` â†’ `start_strategy()` â†’ `run_main_loop()`
2. **è®¢å•æ‰§è¡Œ**: `control_loop()` â†’ `execute_order_operations()` â†’ äº¤æ˜“æ‰€API
3. **ç›‘æ§å‘Šè­¦**: `_monitoring_loop()` â†’ `collect_metrics()` â†’ `check_alerts()`
4. **é£é™©æ§åˆ¶**: `_risk_monitoring_loop()` â†’ `calculate_risk_metrics()` â†’ `emergency_shutdown()`

### æ€§èƒ½ç“¶é¢ˆ
- **ç½‘ç»œIO**: äº¤æ˜“æ‰€APIè°ƒç”¨æ˜¯ä¸»è¦ç“¶é¢ˆ
- **çŠ¶æ€åŒæ­¥**: åŒè´¦æˆ·çŠ¶æ€åŒæ­¥å¼€é”€è¾ƒå¤§
- **æŒ‡æ ‡è®¡ç®—**: å®æ—¶é£é™©æŒ‡æ ‡è®¡ç®—æ¶ˆè€—CPUèµ„æº

### æ‰©å±•æ€§
- **äº¤æ˜“æ‰€æ”¯æŒ**: é€šè¿‡ccxtåº“æ”¯æŒå¤šä¸ªäº¤æ˜“æ‰€
- **ç­–ç•¥æ‰©å±•**: æ‰§è¡Œå™¨æŠ½è±¡è®¾è®¡æ”¯æŒä¸åŒç­–ç•¥
- **ç›‘æ§æ‰©å±•**: æ’ä»¶å¼ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦æœºåˆ¶

### ç»´æŠ¤æ€§
- **æ—¥å¿—å®Œå–„**: ç»“æ„åŒ–æ—¥å¿—è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
- **å¼‚å¸¸åˆ†ç±»**: ç»†åˆ†çš„å¼‚å¸¸ç±»å‹ä¾¿äºé—®é¢˜å®šä½
- **æµ‹è¯•è¦†ç›–**: å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–
- **æ–‡æ¡£é½å…¨**: è¯¦ç»†çš„ä»£ç æ³¨é‡Šå’ŒAPIæ–‡æ¡£

---

*æœ¬åˆ†æåŸºäºé¡¹ç›®å½“å‰ç‰ˆæœ¬ï¼Œéšç€ä»£ç æ¼”è¿›å¯èƒ½éœ€è¦æ›´æ–°*
