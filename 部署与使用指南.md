# 双账号对冲网格策略 - 部署与使用指南

## 📋 目录
1. [系统要求](#系统要求)
2. [安装部署](#安装部署)
3. [配置说明](#配置说明)
4. [使用方法](#使用方法)
5. [监控和维护](#监控和维护)
6. [常见问题](#常见问题)
7. [风险提示](#风险提示)

## 🔧 系统要求

### 硬件要求
- **CPU**: 双核2.0GHz以上
- **内存**: 4GB以上
- **存储**: 10GB可用空间
- **网络**: 稳定的互联网连接，延迟<100ms

### 软件要求
- **操作系统**: Linux/Windows/macOS
- **Python**: 3.9或更高版本
- **Node.js**: 14.0以上（可选，用于Web界面）

### 依赖库
```bash
# 核心依赖
pip install ccxt>=4.0.0
pip install pandas>=1.5.0
pip install numpy>=1.21.0
pip install asyncio
pip install aiohttp>=3.8.0
pip install websockets>=10.0
pip install loguru>=0.6.0
pip install python-binance>=1.0.16
```

## 🚀 安装部署

### 1. 克隆项目
```bash
git clone https://github.com/fm0668/GirdBot.git
cd GirdBot
```

### 2. 安装依赖
```bash
# 使用pip安装
pip install -r requirements.txt

# 或使用conda
conda install --file requirements.txt
```

### 3. 验证安装
```bash
python -c "import ccxt, pandas, numpy; print('安装成功')"
```

## ⚙️ 配置说明

### 1. 基础配置文件

#### config/strategy_config.py
```python
STRATEGY_CONFIG = {
    # 交易对配置
    "symbol": "DOGEUSDC",
    "base_currency": "DOGE",
    "quote_currency": "USDC",
    
    # ATR参数
    "atr_period": 14,              # ATR计算周期
    "atr_multiplier": 2.0,         # ATR倍数
    "kline_interval": "1h",        # K线周期
    
    # 网格参数
    "max_levels": 20,              # 最大网格层数
    "max_open_orders": 10,         # 最大同时挂单数
    "leverage": 25,                # 杠杆倍数
    "safety_factor": 0.9,          # 安全系数(90%资金利用率)
    
    # 风险控制
    "max_drawdown": 0.10,          # 最大回撤10%
    "position_limit": 0.80,        # 持仓限制80%
    "stop_loss_threshold": -1000,  # 止损阈值-1000 USDC
    
    # 运行参数
    "check_interval": 1,           # 检查间隔(秒)
    "sync_interval": 5,            # 同步间隔(秒)
    "log_level": "INFO",           # 日志级别
    
    # 止损参数
    "stop_loss_enabled": True,     # 启用止损
    "atr_stop_multiplier": 3.0,    # ATR止损倍数
    "time_stop_hours": 24,         # 时间止损(小时)
}
```

#### config/account_config.py
```python
ACCOUNT_CONFIG = {
    # 多头账户配置
    "long_account": {
        "api_key": "your_long_api_key",
        "api_secret": "your_long_api_secret",
        "testnet": False,               # 是否使用测试网
        "permissions": ["FUTURES_TRADING"],
        "base_url": "https://fapi.binance.com"
    },
    
    # 空头账户配置
    "short_account": {
        "api_key": "your_short_api_key",
        "api_secret": "your_short_api_secret",
        "testnet": False,
        "permissions": ["FUTURES_TRADING"],
        "base_url": "https://fapi.binance.com"
    },
    
    # 通用配置
    "common": {
        "timeout": 30,                  # 请求超时时间
        "retry_count": 3,               # 重试次数
        "retry_delay": 1,               # 重试延迟
    }
}
```

### 2. 环境变量配置

创建 `.env` 文件：
```bash
# 生产环境配置
ENVIRONMENT=production

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/strategy.log

# 币安API配置
LONG_API_KEY=your_long_api_key
LONG_API_SECRET=your_long_api_secret
SHORT_API_KEY=your_short_api_key
SHORT_API_SECRET=your_short_api_secret

# 通知配置
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id
EMAIL_SMTP_HOST=smtp.gmail.com
EMAIL_SMTP_PORT=587
EMAIL_USERNAME=your_email@gmail.com
EMAIL_PASSWORD=your_email_password

# 数据库配置(可选)
DATABASE_URL=sqlite:///strategy.db
```

## 🎯 使用方法

### 1. 基本启动

#### 快速启动
```bash
# 基础启动
python main.py

# 后台运行
nohup python main.py > logs/strategy.log 2>&1 &

# 使用screen
screen -S grid_strategy
python main.py
# Ctrl+A, D 离开screen
```

#### 使用启动脚本
```bash
# Linux/macOS
chmod +x start.sh
./start.sh

# Windows
start.bat
```

### 2. 高级启动选项

```bash
# 指定配置文件
python main.py --config config/custom_config.py

# 测试模式
python main.py --testnet --dry-run

# 指定交易对
python main.py --symbol BTCUSDT

# 调试模式
python main.py --debug --log-level DEBUG

# 指定资金分配
python main.py --initial-balance 1000
```

### 3. Docker部署

#### 构建镜像
```bash
docker build -t grid-strategy .
```

#### 运行容器
```bash
docker run -d \
  --name grid-strategy \
  -e LONG_API_KEY=your_key \
  -e LONG_API_SECRET=your_secret \
  -e SHORT_API_KEY=your_key \
  -e SHORT_API_SECRET=your_secret \
  -v $(pwd)/logs:/app/logs \
  -v $(pwd)/config:/app/config \
  grid-strategy
```

#### Docker Compose
```yaml
version: '3.8'
services:
  grid-strategy:
    build: .
    container_name: grid-strategy
    restart: unless-stopped
    environment:
      - LONG_API_KEY=${LONG_API_KEY}
      - LONG_API_SECRET=${LONG_API_SECRET}
      - SHORT_API_KEY=${SHORT_API_KEY}
      - SHORT_API_SECRET=${SHORT_API_SECRET}
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    ports:
      - "8080:8080"
```

### 4. 策略控制

#### 启动策略
```bash
# 检查系统状态
python check_system.py

# 验证配置
python validate_config.py

# 启动策略
python main.py
```

#### 停止策略
```bash
# 优雅停止
kill -TERM <PID>

# 强制停止
kill -KILL <PID>

# 紧急停止
python emergency_stop.py
```

#### 策略重启
```bash
# 完整重启
python restart.py

# 重新加载配置
python reload_config.py
```

## 📊 监控和维护

### 1. 日志监控

#### 实时日志查看
```bash
# 查看实时日志
tail -f logs/strategy.log

# 过滤特定级别
tail -f logs/strategy.log | grep ERROR

# 查看最近100行
tail -n 100 logs/strategy.log
```

#### 日志分析工具
```bash
# 统计订单执行情况
python analyze_logs.py --type orders

# 统计盈亏情况
python analyze_logs.py --type pnl

# 性能分析
python analyze_logs.py --type performance
```

### 2. 系统监控

#### 健康检查
```bash
# 系统健康检查
python health_check.py

# 账户状态检查
python check_accounts.py

# 网络连接检查
python check_connection.py
```

#### 监控脚本
```bash
#!/bin/bash
# monitor.sh - 系统监控脚本

while true; do
    # 检查进程是否运行
    if ! pgrep -f "python main.py" > /dev/null; then
        echo "$(date): 策略进程已停止，正在重启..."
        nohup python main.py > logs/strategy.log 2>&1 &
    fi
    
    # 检查内存使用
    memory_usage=$(ps aux | grep "python main.py" | grep -v grep | awk '{print $4}')
    if (( $(echo "$memory_usage > 80" | bc -l) )); then
        echo "$(date): 内存使用过高: $memory_usage%"
        # 发送告警
        python send_alert.py "内存使用过高: $memory_usage%"
    fi
    
    # 检查日志错误
    error_count=$(tail -n 100 logs/strategy.log | grep -c ERROR)
    if [ $error_count -gt 5 ]; then
        echo "$(date): 发现大量错误: $error_count"
        python send_alert.py "发现大量错误: $error_count"
    fi
    
    sleep 60
done
```

### 3. 性能监控

#### 系统指标
```python
# performance_monitor.py
import psutil
import time

def monitor_system():
    """监控系统性能"""
    while True:
        # CPU使用率
        cpu_percent = psutil.cpu_percent(interval=1)
        
        # 内存使用率
        memory = psutil.virtual_memory()
        
        # 网络IO
        network = psutil.net_io_counters()
        
        # 记录到日志
        logger.info(f"系统监控: CPU={cpu_percent}%, 内存={memory.percent}%, "
                   f"网络接收={network.bytes_recv}, 发送={network.bytes_sent}")
        
        time.sleep(60)
```

#### 策略指标
```python
# strategy_monitor.py
def monitor_strategy_metrics():
    """监控策略指标"""
    metrics = {
        'total_pnl': 0,
        'daily_pnl': 0,
        'max_drawdown': 0,
        'win_rate': 0,
        'avg_trade_time': 0,
        'active_orders': 0,
        'position_size': 0,
        'margin_usage': 0,
    }
    
    # 更新指标
    metrics = update_metrics(metrics)
    
    # 记录到数据库
    save_metrics(metrics)
    
    # 发送到监控平台
    send_to_monitoring(metrics)
```

### 4. 告警系统

#### 告警配置
```python
# alert_config.py
ALERT_RULES = {
    'high_drawdown': {
        'threshold': 0.05,
        'enabled': True,
        'message': '最大回撤超过5%'
    },
    'api_error': {
        'threshold': 5,
        'enabled': True,
        'message': 'API错误次数过多'
    },
    'fund_shortage': {
        'threshold': 0.1,
        'enabled': True,
        'message': '资金不足'
    },
    'position_risk': {
        'threshold': 0.8,
        'enabled': True,
        'message': '持仓风险过高'
    }
}
```

#### 告警方式
```python
# alert_manager.py
class AlertManager:
    def __init__(self):
        self.telegram_bot = TelegramBot()
        self.email_client = EmailClient()
        self.webhook_client = WebhookClient()
    
    async def send_alert(self, alert_type: str, message: str):
        """发送告警"""
        # Telegram通知
        await self.telegram_bot.send_message(f"🚨 {alert_type}: {message}")
        
        # 邮件通知
        await self.email_client.send_email(
            subject=f"策略告警: {alert_type}",
            body=message
        )
        
        # Webhook通知
        await self.webhook_client.send_webhook({
            'type': alert_type,
            'message': message,
            'timestamp': time.time()
        })
```

## ❓ 常见问题

### 1. 启动问题

#### Q: 提示"API权限不足"
**A**: 确保API密钥具有期货交易权限
```bash
# 检查API权限
python check_api_permissions.py
```

#### Q: 提示"网络连接失败"
**A**: 检查网络连接和防火墙设置
```bash
# 测试连接
python test_connection.py
```

#### Q: 提示"资金不足"
**A**: 确保账户有足够的USDC余额
```bash
# 检查账户余额
python check_balance.py
```

### 2. 运行问题

#### Q: 订单执行失败
**A**: 检查持仓模式和交易对状态
```bash
# 检查持仓模式
python check_position_mode.py

# 检查交易对信息
python check_symbol_info.py
```

#### Q: 策略频繁重启
**A**: 检查日志文件，排查具体错误
```bash
# 查看错误日志
grep ERROR logs/strategy.log | tail -20
```

#### Q: 盈亏异常
**A**: 检查对冲是否正常工作
```bash
# 检查对冲状态
python check_hedge_status.py
```

### 3. 性能问题

#### Q: 响应速度慢
**A**: 优化网络配置和参数设置
```python
# 优化配置
STRATEGY_CONFIG = {
    "check_interval": 0.5,  # 降低检查间隔
    "max_concurrent_requests": 20,  # 增加并发数
    "timeout": 10,  # 降低超时时间
}
```

#### Q: 内存占用过高
**A**: 定期清理缓存和日志
```bash
# 清理日志
find logs/ -name "*.log" -mtime +7 -delete

# 重启策略
python restart.py
```

## ⚠️ 风险提示

### 1. 市场风险
- **价格波动**: 极端市场条件下可能造成损失
- **流动性风险**: 低流动性可能导致滑点过大
- **系统性风险**: 整体市场崩盘的风险

### 2. 技术风险
- **网络中断**: 可能导致无法及时止损
- **API限制**: 频率限制可能影响策略执行
- **软件故障**: 程序错误可能导致意外损失

### 3. 操作风险
- **配置错误**: 错误的参数设置可能放大损失
- **账户安全**: API密钥泄露的风险
- **人为操作**: 手动干预可能破坏策略逻辑

### 4. 风险控制建议
1. **小额测试**: 先用小额资金测试策略
2. **分散风险**: 不要将所有资金投入单一策略
3. **定期检查**: 定期检查策略运行状态
4. **止损设置**: 设置合理的止损参数
5. **监控告警**: 建立完善的监控和告警系统

## 📞 技术支持

### 联系方式
- **GitHub**: https://github.com/fm0668/GirdBot
- **邮箱**: support@gridbot.com
- **文档**: https://docs.gridbot.com

### 社区支持
- **Discord**: https://discord.gg/gridbot
- **Telegram**: https://t.me/gridbot_community
- **Reddit**: https://reddit.com/r/gridbot

---

*本指南涵盖了双账号对冲网格策略的完整部署和使用流程。在实际使用前，请务必仔细阅读风险提示并进行充分的测试。*
